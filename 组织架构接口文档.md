<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sanfan.org.dao.EmployeeDao">


	<select id="find" resultType="com.sanfan.org.dto.EmployeeDTO" parameterType="com.sanfan.org.dto.EmployeeDTO">
		select
		e.*,
		getCompanySettingName(e.position_id) as 'positionName',
		d.name as 'departmentName'
		from org_employee e
		left join org_department d on e.department_id = d.id
		left join org_company_setting_model m on e.position_id = m.id
		where
		1=1
		and e.status != 'DELETE'
		<if test="companyId != null and companyId != ''">
			and e.company_id = #{companyId}
		</if>
		<if test="departmentId != null and departmentId != ''">
			and e.department_id = #{departmentId}
		</if>
		<if test="role != null ">
			and e.role = #{role}
		</if>
		<if test="searchText != null and searchText !='' ">
			and (
			   d.name like  CONCAT('%',#{searchText},'%')
			   or e.name like CONCAT('%',#{searchText},'%')
			   or e.phone like CONCAT('%',#{searchText},'%')
			   or m.name like CONCAT('%',#{searchText},'%')
			)
		</if>
		<if test="ids != null and ids.size != 0">
			and e.id in
			<foreach collection="ids" item="eid"
					 index="index" open="(" close=")" separator=",">
				#{eid}
			</foreach>
		</if>
	</select>

	<select id="findOne" resultType="com.sanfan.org.dto.EmployeeDTO">
			select
		e.*,
		getCompanySettingName(e.position_id) as 'positionName',
		d.name as 'departmentName'
		from org_employee e
		left join org_department d on e.department_id = d.id
		where
		  e.id = #{id}
	</select>

    <select id="findDirectlyEmployee" resultType="com.sanfan.org.dto.EmployeeDTO">

		select
			e.*,
			getCompanySettingName(e.position_id) as 'positionName',
			d.name as 'departmentName'
		from org_employee e left join org_department d on e.department_id = d.id
		where
			e.status = 'ENABLED'
			and e.status != 'DELETE'
			and e.company_id = #{companyId}
			<if test="role.name == 'SUPERADMIN'">
				and ((e.department_id = #{departmentId} and e.role = 'EMPLOYEE') or (d.parent_id = #{departmentId} and e.role = 'DEPARTMENTADMIN'))
			</if>
			<if test="role.name == 'DEPARTMENTADMIN'">
				and ((e.department_id = #{departmentId} and e.role = 'EMPLOYEE') or (d.parent_id = #{departmentId} and e.role = 'DEPARTMENTADMIN'))
			</if>
			<if test="role.name == 'EMPLOYEE'">
				and 1 = 0
			</if>

	</select>

	<select id="findDirectlyEmployeeIds" resultType="java.lang.String">
		select
		e.id
		from org_employee e left join org_department d on e.department_id = d.id
		where
		e.status = 'ENABLED'
		and e.status != 'DELETE'
		and e.company_id = #{companyId}
		<if test="role.name == 'SUPERADMIN'">
			and ((e.department_id = #{departmentId} and e.role = 'EMPLOYEE') or (d.parent_id = #{departmentId} and e.role = 'DEPARTMENTADMIN'))
		</if>
		<if test="role.name == 'DEPARTMENTADMIN'">
			and ((e.department_id = #{departmentId} and e.role = 'EMPLOYEE') or (d.parent_id = #{departmentId} and e.role = 'DEPARTMENTADMIN'))
		</if>
		<if test="role.name == 'EMPLOYEE'">
			and 1 = 0
		</if>
	</select>

	<select id="findByPermissionType" resultType="com.sanfan.org.dto.EmployeeDTO">
		select
		e.*,
		getCompanySettingName(e.position_id) as 'positionName',
		d.name as 'departmentName'
		from org_employee e
		left join org_employee_permission p on e.id = p.employee_id
		left join org_department d on e.department_id = d.id
		where
		e.status != 'DELETE'
		and e.company_id = #{companyId}
		and p.type = #{type}
	</select>

	<select id="findAllByDepartmentId" resultType="com.sanfan.org.dto.EmployeeDTO"
			parameterType="com.sanfan.org.dto.EmployeeDTO">
		select
		e.*,
		getCompanySettingName(e.position_id) as 'positionName',
		d.name as 'departmentName'
		from org_employee e
		left join org_department d on e.department_id = d.id
		left join org_company_setting_model m on e.position_id = m.id
		where
		1=1
		and e.status != 'DELETE'
		<if test="companyId != null and companyId != ''">
			and e.company_id = #{companyId}
		</if>
		<if test="departmentId != null and departmentId != ''">
			and (e.department_id = #{departmentId})
			or (d.parent_id = #{departmentId})
		</if>
		<if test="role != null ">
			and e.role = #{role}
		</if>
	</select>

	<select id="findAllManager" resultType="com.sanfan.org.dto.EmployeeDTO">
		select
		e.*,
		getCompanySettingName(e.position_id) as 'positionName',
		d.name as 'departmentName'
		from org_employee e
		left join org_employee_permission p on e.id = p.employee_id
		left join org_department d on e.department_id = d.id
		where
		e.status != 'DELETE'
		and e.company_id = #{companyId}
		and p.type in ('FINANCE','ADMINISTRATION','DEPARTMENT','SUPERADMIN')
	</select>

</mapper>
